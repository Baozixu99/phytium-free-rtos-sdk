# E1000E 驱动程序

## 1. 概述

E1000E 是 Intel 开发的一款高性能 PCIe 网卡驱动程序，专为支持 Intel Gigabit Ethernet 控制器的设备设计。它能够在各种操作系统中实现高效的网络数据传输，提供稳定、低延迟的网络连接。E1000E 驱动程序兼容多种 Intel 千兆网卡，支持多种网络协议和特性，是工业、企业和消费级网络应用中广泛采用的解决方案。

## 2. 功能

E1000E控制器驱动提供了E1000E的控制访问方法，

- 初始化E1000E控制器
- 以轮询方式发送/接收数据

驱动相关的源文件包括，

```
.
├── e1000e_debug.c
├── e1000e_dma.c
├── e1000e_g.c
├── e1000e_hw.c
├── e1000e_hw.h
├── e1000e_phy.c
├── e1000e_phy.h
├── e1000e_sinit.c
├── e1000e.c
└── e1000e.h
```

## 3. 配置方法

以下部分将指导您完成 e1000e 驱动的软件配置:

- 初始化E1000E控制器

## 4 应用示例

### [lwip_startup例程](../../../example/network/lwip_startup)

## 5. API参考

### 5.1. 用户数据结构

- e1000e控制数据

```c
typedef struct
{
    FE1000EConfig config;
	FE1000ERingDescData rx_ring;
	FE1000ERingDescData tx_ring;
	volatile struct e1000_tx tx[TX_DESCRIPTORS] __aligned(16);
	volatile struct e1000_rx rx[RX_DESCRIPTORS] __aligned(16);
	uint8_t txb[TX_DESCRIPTORS * RX_BUFFER_SIZE];
	uint8_t rxb[RX_DESCRIPTORS * RX_BUFFER_SIZE];
	uint8_t mac[ETH_ALEN];
    u32 is_ready;
	FE1000EEvtHandler evt_handler[FE1000E_INTR_EVT_NUM];
} FE1000ECtrl;
```

- e1000e配置数据，FE1000EConfig主要是e1000e控制器id、基地址、速度、双工和自协商，FE1000EPhyInterface主要包括各种物理接口模式

```c
typedef struct
{
    u32 instance_id;
    uintptr base_addr;
	FE1000EPhyInterface interface;
    u32 speed;    /* FE1000E_SPEED_XXX */
    u32 duplex;   /* 1 is full-duplex , 0 is half-duplex */
    u32 auto_neg; /* Enable auto-negotiation - when set active high, autonegotiation operation is enabled. */
} FE1000EConfig;
```

- e1000e物理接口配置

```c
typedef enum
{
    FE1000E_PHY_INTERFACE_MODE_SGMII,
    FE1000E_PHY_INTERFACE_MODE_RMII,
    FE1000E_PHY_INTERFACE_MODE_RGMII,
    FE1000E_PHY_INTERFACE_MODE_XGMII,
    FE1000E_PHY_INTERFACE_MODE_USXGMII,
    FE1000E_PHY_INTERFACE_MODE_5GBASER ,
    FE1000E_PHY_INTERFACE_MODE_2500BASEX
} FE1000EPhyInterface;
```

- e1000e发送描述符

```c
struct FE1000ETxDesc
{
	uint64_t addr;
	uint16_t len;
	uint8_t  cso;
	uint8_t  cmd;
	uint8_t  sta;
	uint8_t  css;
	uint16_t special;
};
```

- e1000e接收描述符

```c
struct FE1000ERxDesc
{
	uint64_t addr;
	uint16_t len;
	uint16_t csum;
	uint8_t  sta;
	uint8_t  err;
	uint16_t special;
};
```

- e1000e中断事件类型

```c
enum
{
    FE1000E_TX_COMPLETE_EVT = 0,
    FE1000E_RX_COMPLETE_EVT,
    FE1000E_LINK_STATUS_EVT,
    FE1000E_PHY_STATUS_EVT,
    FE1000E_DMA_ERR_EVT,

    FE1000E_INTR_EVT_NUM
}; 
```

### 5.2  错误码定义

- FE1000E_SUCCESS                   执行成功
- FE1000E_ERR_TIMEOUT               执行超时错误
- FE1000E_ERR_INVALID_DMA_MEM       非法DMA内容错误
- FE1000E_ERR_NOT_READY             初始化失败
- FE1000E_ERR_TRANS_FAILED          发送失败
- FE1000E_ERR_PHY_NOT_SUPPORT       物理接口不支持
- FE1000E_ERR_PHY_IS_NOT_FOUND      未发现物理接口
- FE1000E_ERR_FAILED                执行失败
- FE1000E_ERR_PHY_AUTO_FAILED       自协商失败
- FE1000E_ERR_RECEV_FAILED          接收失败

### 5.3. 用户API接口

#### FE1000ELookupConfig

- 获取e1000e控制器默认配置

```c
const FE1000EConfig *FE1000ELookupConfig(u32 instance_id);
```

Note:

- 获取默认配置参数，包括基地址、中断号等

Input:

- {u32} instance_id，控制器id号

Return:

- {const FE1000EConfig *} e1000e默认配置，返回NULL如果找不到默认配置

#### FE1000ECfgInitialize

- 初始化e1000e控制器, 使之可以使用

```c
FError FE1000ECfgInitialize(FE1000ECtrl *instance_p, const FE1000EConfig *input_config_p);
```

Note:

- 输入配置通过FE1000ELookupConfig获取，用户按照需要修改后传入此函数

Input:

- {FE1000ECtrl} *instance_p e1000e驱动控制数据
- {FE1000EConfig} *input_config_p e1000e用户输入配置

Return:

- {FError} 驱动初始化的错误码信息，FE1000E_SUCCESS 表示初始化成功，其它返回值表示初始化失败

#### FE1000ECfgDeInitialize

- 完成e1000e驱动实例去使能，清零实例数据

```c
void FE1000ECfgDeInitialize(FE1000ECtrl *pctrl);
```

Note:

- 在调用此函数之前，必须确保控制器已经停止工作

Input:

- {FE1000ECtrl} *instance_p e1000e驱动控制数据

Return:

- 无

#### FE1000ESetupTxDescRing

- 配置e1000e的发送DMA描述符和缓冲区

```c
FError FE1000ESetupTxDescRing(FE1000ECtrl *instance_p);
```

Note:

- 需要在控制器已正确初始化后调用此函数

Input:

- {FE1000ECtrl} *instance_p e1000e驱动控制数据

Return:

- {FError} TX DMA初始化的错误码信息，FE1000E_SUCCESS 表示TX DMA初始化成功，其它返回值表示TX DMA初始化失败

#### FE1000ESetupRxDescRing

- 配置e1000e的接收DMA描述符和缓冲区

```c
FError FE1000ESetupRxDescRing(FE1000ECtrl *instance_p);
```

Note:

- 需要在控制器已正确初始化后调用此函数

Input:

- {FE1000ECtrl} *instance_p e1000e驱动控制数据

Return:

- {FError} RX DMA初始化的错误码信息，FE1000E_SUCCESS 表示RX DMA初始化成功，其它返回值表示RX DMA初始化失败

#### FE1000EStart

- 用于启动e1000e控制器设备实例

```c
void FE1000EStart(FE1000ECtrl *instance_p);
```

Note:

- 在调用此函数之前，必须确保设备实例已经通过 FE1000ECfgInitialize 初始化

Input:

- {FE1000ECtrl} *instance_p e1000e驱动控制数据

Return:

- {FError} FE1000E_SUCCESS 表示启动成功，其它返回值表示启动失败

#### FE1000EStop

- 用于停止e1000e控制器设备实例

```c
void FE1000EStop(FE1000ECtrl *instance_p);
```

Note:

- 在调用此函数之前，必须确保设备实例已经通过 FE1000ECfgInitialize 初始化

Input:

- {FE1000ECtrl} *instance_p e1000e驱动控制数据

Return:

- {FError} FE1000E_SUCCESS 表示去启动成功，其它返回值表示去启动失败

#### FE1000ERecvFrame

- 用于接收通过e1000e控制器的数据帧

```c
FError FE1000ERecvFrame(FE1000ECtrl *instance_p)
```

Note:

- 在调用此函数之前，必须确保 E1000E 驱动已成功初始化

Input:

- {FE1000ECtrl} *instance_p e1000e驱动控制数据

Return:

- {FError} FE1000E_SUCCESS 表示接收数据帧成功，其它返回值表示接收数据帧失败

#### FE1000ESendFrame

- 用于通过 E1000E 控制器发送数据帧

```c
FError FE1000ESendFrame(FE1000ECtrl *instance_p, u32 frame_len);
```

Note:

- 在调用此函数之前，必须确保 E1000E 驱动已成功初始化

Input:

- {FE1000ECtrl} *instance_p e1000e驱动控制数据

Return:

- {FError} FE1000E_SUCCESS 表示发送数据帧成功，其它返回值表示发送数据帧失败

#### FE1000ESoftwareReset

- 用于触发 E1000E 控制器的软复位 

```c
FError FE1000ESoftwareReset(uintptr addr);
```

Note:

该函数会触发软复位并进行一些初始化设置，确保控制器处于正常工作状态

Input:

- {uintptr} addr E1000E控制器的基地址，指向设备的内存映射寄存器

Return:

- {FError} FE1000E_SUCCESS 表示发送数据帧成功，其它返回值表示发送数据帧失败

#### FE1000EGetMacAddr

- 用于获取 E1000E 控制器的 MAC 地址

```c
void FE1000EGetMacAddr(FE1000ECtrl *instance_p);
```

Note:

在读取 MAC 地址之前，确保 FE1000E 控制器已经成功初始化

Input:

- {FE1000ECtrl} *instance_p e1000e驱动控制数据

Return:

- 无

#### FE1000ESetMacAddr

- 用于将给定的 MAC 地址设置到 E1000E 控制器

```c
void FE1000ESetMacAddr(FE1000ECtrl *instance_p);
```

Note:

确保在调用该函数之前，MAC 地址的正确性

Input:

- {FE1000ECtrl} *instance_p e1000e驱动控制数据

Return:

- 无

#### FE1000EReset

- 用于重置 E1000E 控制器

```c
FError FE1000EReset(FE1000ECtrl *instance_p);
```

Note:

调用该函数时需要确保 instance_p 是有效的，并且控制器的配置已经正确初始化

Input:

- {FE1000ECtrl} *instance_p e1000e驱动控制数据

Return:

- {FError} FE1000E_SUCCESS 表示发送数据帧成功，其它返回值表示发送数据帧失败

#### FE1000EPhyWrite

- 用于向以太网控制器的 PHY 寄存器写入数据

```c
FError FE1000EPhyWrite(uintptr base_addr, unsigned int reg, uint16_t val);
```

Note:

该函数不是线程安全的。如果多个线程可能同时访问此函数，用户需要确保使用互斥机制来避免并发问题

Input:

- {uintptr} base_addr e1000e控制器寄存器空间的基地址
- {unsigned int} reg 要写入的 PHY 寄存器号
- {uint16_t} val 要写入的值

Return:

- {FError} FE1000E_SUCCESS 表示发送数据帧成功，其它返回值表示发送数据帧失败

#### FE1000EPhyRead

- 用于从指定的 PHY 寄存器读取数据

```c
uint16_t FE1000EPhyRead(uintptr base_addr, unsigned int reg);
```

Note:

该函数不是线程安全的。如果多个线程可能同时访问此函数，用户需要确保使用互斥机制来避免并发问题

Input:

- {uintptr} base_addr e1000e控制器寄存器空间的基地址
- {unsigned int} reg 要读取的 PHY 寄存器号

Return:

- {uint16_t} 返回指定 PHY 寄存器的 16 位值
